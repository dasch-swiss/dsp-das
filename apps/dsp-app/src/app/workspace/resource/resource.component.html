<div class="restricted-message" *ngIf="resource?.res?.userHasPermission === 'RV' && showRestrictedMessage">
  <mat-icon>report_problem</mat-icon>
  <p>This resource is restricted, file representations may be of lower quality and some properties may be hidden.</p>
  <mat-icon class="close" (click)="showRestrictedMessage = false">clear</mat-icon>
</div>
<div class="content large middle">
  <div class="resource-view" *ngIf="resource">
    <!-- dsp-resource-representation -->
    <div class="resource-header">
      <div class="resource-class-header">
        <h3>{{resourceClassLabel(resource)}}<span *ngIf="resource.res.isDeleted">(deleted)</span></h3>
        <span class="action" *ngIf="project$ | async" [class.deleted]="resource.res.isDeleted">
          <!-- Share resource: copy ark url, add to favorites or open in new tab -->
          <button
            color="primary"
            mat-icon-button
            class="share-res"
            matTooltip="Share resource: {{resource.res.versionArkUrl}}"
            matTooltipPosition="above"
            [disabled]="resource.res.isDeleted"
            [matMenuTriggerFor]="share">
            <mat-icon>share</mat-icon>
            <!-- <span class="desktop-only">Citation Link</span> -->
          </button>
          <mat-menu #share="matMenu" class="res-share-menu">
            <button
              mat-menu-item
              matTooltip="Copy ARK url"
              matTooltipPosition="above"
              [cdkCopyToClipboard]="resource.res.versionArkUrl"
              (click)="notification.openSnackBar('ARK URL copied to clipboard!')">
              <mat-icon>content_copy</mat-icon>
              Copy ARK url to clipboard
            </button>
            <button
              mat-menu-item
              matTooltip="Copy internal link"
              matTooltipPosition="above"
              [cdkCopyToClipboard]="resource.res.id"
              (click)="notification.openSnackBar('Internal link copied to clipboard!')">
              <mat-icon>content_copy</mat-icon>
              Copy internal link to clipboard
            </button>
            <button
              mat-menu-item
              matTooltip="Open in new tab"
              matTooltipPosition="above"
              (click)="openResource(resource.res.id)">
              <mat-icon>open_in_new</mat-icon>
              Open resource in new tab
            </button>
            <!-- TODO: activate favorite action to add resource to collection -->
            <!--
                <button mat-button class="add-res-to-collection">
                    <mat-icon>star_border</mat-icon>
                </button>
                -->
          </mat-menu>
        </span>
      </div>
      <p class="resource-label">{{resourceLabel(incomingResource, resource)}}</p>
      <div class="infobar mat-caption" *ngIf="(project$ | async) as project">
        Resource of the project
        <span
          class="project link"
          [title]="project.longname"
          (click)="openProject(project)"
          (mouseover)="previewProject()">
          <strong>{{project?.shortname}}</strong>
          <mat-icon inline>open_in_new</mat-icon>
        </span>
        <span *ngIf="resourceAttachedUser || resource.res.creationDate">
          , created
          <span *ngIf="resourceAttachedUser"
            >by {{(resourceAttachedUser.username ? resourceAttachedUser.username : resourceAttachedUser.givenName + ' '
            + resourceAttachedUser.familyName)}}</span
          >
          <span *ngIf="resource.res.creationDate"> on {{resource.res.creationDate | date}}</span>
        </span>
      </div>
    </div>
    <div
      class="representation-container center"
      *ngIf="representationsToDisplay?.length && representationsToDisplay[0].fileValue"
      [ngSwitch]="representationsToDisplay[0].fileValue?.type">
      <!-- still image view -->
      <app-still-image
        #stillImage
        class="dsp-representation stillimage"
        *ngSwitchCase="representationConstants.stillImage"
        [images]="representationsToDisplay"
        [imageCaption]="resourceLabel(incomingResource, resource)"
        [compoundNavigation]="compoundPosition"
        [resourceIri]="incomingResource ? incomingResource.res.id : resource.res.id"
        [project]="resource.res.attachedToProject"
        [currentTab]="selectedTabLabel"
        [parentResource]="incomingResource ? incomingResource.res : resource.res"
        [activateRegion]="selectedRegion"
        [adminPermissions]="isAdmin$ | async"
        (loaded)="representationLoaded($event)"
        (goToPage)="compoundNavigation($event)"
        (regionClicked)="openRegion($event)"
        (regionAdded)="updateRegions($event)">
      </app-still-image>

      <app-document
        #document
        class="dsp-representation document"
        [class.pdf]="representationsToDisplay[0].fileValue.filename.split('.').pop() === 'pdf'"
        *ngSwitchCase="representationConstants.document"
        [src]="representationsToDisplay[0]"
        [parentResource]="resource.res"
        (loaded)="representationLoaded($event)">
      </app-document>

      <app-audio
        #audio
        class="dsp-representation audio"
        *ngSwitchCase="representationConstants.audio"
        [src]="representationsToDisplay[0]"
        [parentResource]="resource.res"
        (loaded)="representationLoaded($event)">
      </app-audio>

      <app-video
        #video
        class="dsp-representation video"
        *ngSwitchCase="representationConstants.movingImage"
        [src]="representationsToDisplay[0]"
        [parentResource]="resource.res"
        [splitSizeChanged]="splitSizeChanged"
        (loaded)="representationLoaded($event)">
      </app-video>

      <app-archive
        #archive
        class="dsp-representation archive"
        *ngSwitchCase="representationConstants.archive"
        [src]="representationsToDisplay[0]"
        [parentResource]="resource.res"
        (loaded)="representationLoaded($event)">
      </app-archive>

      <app-text
        #text
        class="dsp-representation text"
        *ngSwitchCase="representationConstants.text"
        [src]="representationsToDisplay[0]"
        [parentResource]="resource.res"
        (loaded)="representationLoaded($event)">
      </app-text>

      <span *ngSwitchDefault>
        The file representation type "{{representationsToDisplay[0].fileValue.type}}" is not yet implemented
      </span>

      <!-- TODO: here we'll add more viewers and players dsp-moving-image, dsp-audio etc. -->
    </div>
    <div class="data-container" *ngIf="!loading">
      <!-- tabs -->
      <mat-tab-group
        *ngIf="!resource.res.isDeleted; else deletedResource"
        animationDuration="0ms"
        [(selectedIndex)]="selectedTab"
        (selectedTabChange)="tabChanged($event)">
        <!-- first tab for the main resource e.g. book -->
        <mat-tab #matTabProperties>
          <ng-template mat-tab-label>
            <ng-container
              *ngTemplateOutlet="toggleShowAllPropsButtonTemplate; context: { label: 'appLabels.resource.properties' | translate, isActive: matTabProperties.isActive }">
            </ng-container>
          </ng-template>
          <app-properties
            *ngIf="resource.res"
            [resource]="resource"
            [attachedUser]="resourceAttachedUser"
            [attachedProject]="project$ | async"
            [adminPermissions]="isAdmin$ | async"
            [valueUuidToHighlight]="valueUuid">
          </app-properties>
        </mat-tab>

        <!-- incoming resource -->
        <mat-tab *ngIf="incomingResource" #matTabIncoming>
          <ng-template mat-tab-label>
            <ng-container
              *ngTemplateOutlet="toggleShowAllPropsButtonTemplate; context: { label: resourceClassLabel(incomingResource), isActive: matTabIncoming.isActive }">
            </ng-container>
          </ng-template>
          <app-properties
            *ngIf="incomingResource.res"
            [resource]="incomingResource"
            [adminPermissions]="isAdmin$ | async"
            [attachedUser]="resourceAttachedUser"
            [attachedProject]="project$ | async"
            [valueUuidToHighlight]="valueUuid">
          </app-properties>
        </mat-tab>

        <!-- annotations -->
        <mat-tab
          label="annotations"
          *ngIf="representationsToDisplay?.length && representationsToDisplay[0].fileValue && representationsToDisplay[0].fileValue.type === representationConstants.stillImage">
          <ng-template matTabLabel class="annotations">
            <span
              [matBadge]="representationsToDisplay[0]?.annotations.length"
              [matBadgeHidden]="representationsToDisplay[0]?.annotations.length === 0"
              matBadgeColor="primary"
              matBadgeOverlap="false">
              Annotations
            </span>
          </ng-template>
          <div
            class="region-property"
            *ngFor="let annotation of annotationResources"
            [id]="annotation.res.id"
            [class.active]="annotation.res.id === selectedRegion">
            <app-properties
              [resource]="annotation"
              [isAnnotation]="true"
              [adminPermissions]="isAdmin$ | async"
              [attachedUser]="resourceAttachedUser"
              [attachedProject]="project$ | async"
              [valueUuidToHighlight]="valueUuid"
              (regionChanged)="updateRegion()"
              (regionDeleted)="reloadWithResource()">
            </app-properties>
          </div>
        </mat-tab>
      </mat-tab-group>
      <ng-template #deletedResource>
        <app-properties
          *ngIf="resource.res"
          [resource]="resource"
          [attachedUser]="resourceAttachedUser"
          [attachedProject]="project$ | async"
          [adminPermissions]="isAdmin$ | async"
          [valueUuidToHighlight]="valueUuid">
        </app-properties>
      </ng-template>
    </div>
    <!-- progress indicator -->
    <dasch-swiss-app-progress-indicator *ngIf="loading"></dasch-swiss-app-progress-indicator>
  </div>

  <!-- resource not found  -->
  <div *ngIf="!resource && !loading" class="no-results">
    <p>
      The resource
      <span *ngIf="resourceIri">&mdash; <strong> {{resourceIri}}</strong> &mdash;</span>
      could not be found.
    </p>
    <p>Reasons:</p>
    <ul>
      <li>It could be a deleted resource and does not exist anymore.</li>
      <li>You don't have the permissions to open this resource.</li>
      <li>The identifier or the ARK URL is wrong.</li>
    </ul>
  </div>
</div>

<ng-template #toggleShowAllPropsButtonTemplate let-label="label" let-isActive="isActive">
  <span>{{label}}</span>
  <!-- Toggle list of properties: all or only the ones with value -->
  <button
    color="primary"
    mat-icon-button
    class="toggle-props"
    *ngIf="!resource.res.isDeleted && isActive"
    [matTooltip]="((showAllProps$ | async) ? 'Hide empty' : 'Show all')+' properties'"
    matTooltipPosition="above"
    (click)="toggleShowAllProps()">
    <mat-icon>{{(showAllProps$ | async) ? 'unfold_less' : 'unfold_more'}}</mat-icon>
    <!-- <span class="desktop-only">{{showAllProps ? 'Hide empty' : 'Show all'}} properties</span> -->
  </button>
</ng-template>
