name: Claude Code

on:
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]
  pull_request_review:
    types: [ submitted ]
  issues:
    types: [ opened, assigned ]

# Prevent multiple Claude runs from interfering with each other
concurrency:
  group: claude-${{ github.event.issue.number || github.event.pull_request.number || github.event.number || github.run_id }}
  cancel-in-progress: false

jobs:
  # Job 1: Dedicated code review with predefined prompt which triggers on commands: '@claude review' posted in the comments of a PR
  claude-code-review:
    if: |
      (github.event.issue.pull_request || github.event.pull_request) &&
      (contains(github.event.comment.body, '@claude review') || contains(github.event.review.body, '@claude review'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || (github.event.pull_request && format('refs/pull/{0}/head', github.event.pull_request.number)) || github.ref }}
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage (only for modified code)

            Focus your review **only on files and lines changed in this PR**.
            Do **not** review unrelated parts of the repository.
            Do **not** make any code changes, run commands, or push code; only provide analysis and suggestions.

            Structure your review as follows:
            1. Summary of PR changes
            2. Identified issues (prioritize Critical issues, including bugs, security vulnerabilities, or regressions):
              - Grade each issue as Critical, Major, or Minor.
              - Only Critical issues should prevent the PR from being ready to merge.
              - Minor or style issues should be noted but do not affect merge readiness.
            3. Recommendations for improvement (aligned with the issue severity)
            4. Clear statement whether the PR is ready to merge (based **only** on Critical issues)

            Be constructive, precise, and concise. Avoid verbose explanations unless necessary for clarity.
            Use the repository's CLAUDE.md for guidance on style, conventions, and repository-specific best practices.
            Use `gh pr comment` to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Notify on failure
        if: failure()
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          if [ -n "$PR_NUMBER" ]; then
            gh issue comment "$PR_NUMBER" --body "⚠️ Claude Code Review failed. Check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  # Job 2: General Claude assistant (flexible) available on this repository PRs, issues etc. triggered by "@claude <PROMPT>"
  claude-general:
    if: |
      (contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude review')) ||
      (contains(github.event.review.body, '@claude') && !contains(github.event.review.body, '@claude review')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ (github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number)) || (github.event.pull_request && format('refs/pull/{0}/head', github.event.pull_request.number)) || github.ref }}
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Notify on failure
        if: failure()
        run: |
          PR_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          if [ -n "$PR_NUMBER" ]; then
            gh issue comment "$PR_NUMBER" --body "⚠️ Claude Code failed. Check [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi
        env:
          GH_TOKEN: ${{ github.token }}
