<div class="advanced-search-container">
  <div class="advanced-search-header">
    <h2>{{ 'pages.search.advancedSearch.title' | translate }}</h2>
    <button [disabled]="!previousSearchObject" mat-stroked-button color="primary" (click)="loadPreviousSearch()">
      {{ 'pages.search.advancedSearch.usePreviousSearch' | translate }}
    </button>
  </div>
  <div
    *ngIf="{
            ontologies: ontologies$ | async,
            ontologiesLoading: ontologiesLoading$ | async,
            resourceClasses: resourceClasses$ | async,
            resourceClassesLoading: resourceClassesLoading$ | async,
            searchButtonDisabled: searchButtonDisabled$ | async,
            propertyFormList: propertyFormList$ | async,
            propertiesOrderByList: propertiesOrderByList$ | async,
            propertiesLoading: propertiesLoading$ | async,
            filteredProperties: filteredProperties$ | async,
            resetButtonDisabled: resetButtonDisabled$ | async,
            selectedOntology: selectedOntology$ ? (selectedOntology$ | async) : undefined,
            selectedResourceClass: selectedResourceClass$ ? (selectedResourceClass$| async) : undefined,
            matchResourceClassesLoading: matchResourceClassesLoading$ | async,
            resourcesSearchResultsLoading: resourcesSearchResultsLoading$ | async,
            resourcesSearchResultsCount: resourcesSearchResultsCount$ | async,
            resourcesSearchResults: resourcesSearchResults$ | async,
            resourcesSearchNoResults: resourcesSearchNoResults$ | async,
            orderByButtonDisabled: orderByButtonDisabled$ | async,
        } as asyncData"
    class="advanced-search-item">
    <app-ontology-resource-form
      [ontologies]="asyncData.ontologies"
      [ontologiesLoading]="asyncData.ontologiesLoading"
      [resourceClasses]="asyncData.resourceClasses"
      [resourceClassesLoading]="asyncData.resourceClassesLoading"
      [selectedOntology]="asyncData.selectedOntology"
      [selectedResourceClass]="asyncData.selectedResourceClass"
      (emitSelectedOntology)="handleSelectedOntology($event)"
      (emitSelectedResourceClass)="handleSelectedResourceClass($event)" />

    <ng-container *ngFor="let propertyForm of asyncData.propertyFormList; let isLast = last">
      <div style="display: flex; width: 100%; padding-left: 2em">
        <app-property-form
          class="advanced-search-item"
          [matchResourceClassesLoading]="asyncData.matchResourceClassesLoading"
          [resourcesSearchResultsLoading]="asyncData.resourcesSearchResultsLoading"
          [resourcesSearchResultsCount]="asyncData.resourcesSearchResultsCount"
          [resourcesSearchResults]="asyncData.resourcesSearchResults"
          [resourcesSearchNoResults]="asyncData.resourcesSearchNoResults"
          [propertyFormItem]="propertyForm"
          [properties]="asyncData.filteredProperties"
          [propertiesLoading]="asyncData.propertiesLoading"
          [selectedProperty]="propertyForm.selectedProperty"
          [selectedOperator]="propertyForm.selectedOperator"
          (emitSelectedPropertyChanged)="handleSelectedPropertyChanged($event)"
          (emitSelectedOperatorChanged)="handleSelectedOperatorChanged($event)"
          (emitSelectedMatchPropertyResourceClassChanged)="handleSelectedMatchPropertyResourceClassChanged($event)"
          (emitSearchValueChanged)="handleSearchValueChanged($event)"
          (emitResourceSearchValueChanged)="handleResourceSearchValueChanged($event)"
          (emitLoadMoreSearchResults)="handleLoadMoreSearchResults($event)"
          (emitAddChildPropertyForm)="handleAddChildPropertyForm($event)"
          (emitRemoveChildPropertyForm)="handleRemoveChildPropertyForm($event)"
          (emitChildSelectedPropertyChanged)="handleChildSelectedPropertyChanged($event)"
          (emitChildSelectedOperatorChanged)="handleChildSelectedOperatorChanged($event)"
          (emitChildValueChanged)="handleChildValueChanged($event)" />
        <div class="remove-button-container" *ngIf="!isLast && propertyForm.selectedProperty">
          <button
            mat-icon-button
            (click)="handleRemovePropertyForm(propertyForm)"
            class="remove-property-button"
            matTooltip="Remove search criteria">
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
      </div>
      <!-- Subcriteria component -->
      <app-property-form-subcriteria
        class="advanced-search-item"
        [parentProperty]="propertyForm"
        [childProperties]="getLinkMatchPropertyFormItems(propertyForm.searchValue) || []"
        [resourcesSearchResultsLoading]="asyncData.resourcesSearchResultsLoading"
        [resourcesSearchResultsCount]="asyncData.resourcesSearchResultsCount"
        [resourcesSearchResults]="asyncData.resourcesSearchResults"
        [resourcesSearchNoResults]="asyncData.resourcesSearchNoResults"
        (emitAddChildPropertyForm)="handleAddChildPropertyForm($event)"
        (emitRemoveChildPropertyForm)="handleRemoveChildPropertyForm($event)"
        (emitChildSelectedPropertyChanged)="handleChildSelectedPropertyChanged($event)"
        (emitChildSelectedOperatorChanged)="handleChildSelectedOperatorChanged($event)"
        (emitChildValueChanged)="handleChildValueChanged($event)"
        (emitResourceSearchValueChanged)="handleResourceSearchValueChanged($event)"
        (emitLoadMoreSearchResults)="handleLoadMoreSearchResults($event)" />
    </ng-container>

    <app-order-by
      [orderByList]="asyncData.propertiesOrderByList"
      [orderByDisabled]="asyncData.orderByButtonDisabled"
      (emitPropertyOrderByChanged)="handlePropertyOrderByChanged($event)" />
    <app-form-actions
      [resetButtonDisabled]="asyncData.resetButtonDisabled"
      [searchButtonDisabled]="asyncData.searchButtonDisabled"
      (emitResetButtonClicked)="handleResetButtonClicked()"
      (emitSearchButtonClicked)="handleSearchButtonClicked()" />
  </div>
</div>
