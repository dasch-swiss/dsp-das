# Environment URLs
devUrl := "https://app.dev.dasch.swiss"
dev02Url := "https://app.dev-02.dasch.swiss"
stageUrl := "https://app.stage.dasch.swiss"
prodUrl := "https://app.dasch.swiss"

# Default settings
appUrl := devUrl
testToRun := "first-page-load"
#k6_browser_headless := "false"
k6_browser_headless := "true"

# List all the available targets
default:
    @just --list

# List all the available tests
list:
    @echo "Choose a test from below:"
    @echo ""
    @ls -1 tests|sed 's/\.js//'|awk '{print " * " $0}'
    @echo ""
    @echo "Run the test using 'just run <testName>'"

# Run test with flexible environment selection
run testToRun=testToRun env="dev" k6_browser_headless=k6_browser_headless:
    #!/usr/bin/env bash
    case "{{env}}" in
        "dev") url="{{devUrl}}" ;;
        "dev02") url="{{dev02Url}}" ;;
        "stage") url="{{stageUrl}}" ;;
        "prod") url="{{prodUrl}}" ;;
        *) url="{{env}}" ;;  # Allow custom URLs
    esac
    K6_BROWSER_HEADLESS={{k6_browser_headless}} APP_URL="$url" k6 run tests/{{testToRun}}.js --out json=results/{{testToRun}}-{{env}}.json

# Run all tests locally
run-all:
    APP_URL={{appUrl}} k6 run tests/first-page-load.js
    APP_URL={{appUrl}} k6 run tests/load-project-overview.js
    APP_URL={{appUrl}} k6 run tests/load-resource.js
    APP_URL={{appUrl}} k6 run tests/load-single-resource.js
    APP_URL={{appUrl}} k6 run tests/workflow-login-success.js

# Run the test in k6 cloud
run-cloud testToRun=testToRun:
    k6 cloud tests/{{testToRun}}.js

# Start grafana
grafana-up:
    docker compose up -d
    open http://localhost:3000/dashboard/new?orgId=1
    cat ./grafana_dashboard.json | pbcopy

# Stop grafana
grafana-down:
    docker compose down

# Run test with Grafana output (flexible environment)
run-grafana testToRun=testToRun env="dev":
    #!/usr/bin/env bash
    case "{{env}}" in
        "dev") url="{{devUrl}}" ;;
        "dev02") url="{{dev02Url}}" ;;
        "stage") url="{{stageUrl}}" ;;
        "prod") url="{{prodUrl}}" ;;
        *) url="{{env}}" ;;
    esac
    K6_OUT=influxdb=http://localhost:8086/k6 APP_URL="$url" k6 run ./tests/{{testToRun}}.js --tag env={{env}}

# Remove all screenshots
clean:
    rm screenshots/*.png


# Flexible comparison between any two environments
compare testToRun=testToRun env1="stage" env2="dev02":
    @echo "ðŸ”¬ Performance Comparison: {{testToRun}}"
    @echo "=================================="
    @echo "ðŸŸ¡ Testing {{env1}} environment..."
    just run {{testToRun}} {{env1}}
    @echo ""
    @echo "ðŸ”µ Testing {{env2}} environment..."
    just run {{testToRun}} {{env2}}
    @echo ""
    @echo "âœ… Comparison complete: {{env1}} vs {{env2}}"

# State performance tests (flexible environment)
state-performance env="dev":
    @echo "ðŸ”¬ Running comprehensive state management tests on {{env}}"
    just run state-management {{env}}

state-quick env="dev":
    @echo "ðŸ”¬ Running quick state performance tests on {{env}}"
    just run state-quick {{env}}

ui-performance env="dev":
    @echo "ðŸ”¬ Running UI interaction performance tests on {{env}}"
    just run ui-interactions {{env}}

state-stats env="dev":
    @echo "ðŸ“Š Running statistical state performance tests on {{env}}"
    just run state-stats {{env}}

# Compare state performance between environments
state-compare env1="stage" env2="dev02":
    @echo "ðŸ”¬ State Performance Comparison: {{env1}} vs {{env2}}"
    @echo "================================================="
    @echo "ðŸŸ¡ Testing {{env1}} environment..."
    just state-quick {{env1}}
    @echo ""
    @echo "ðŸ”µ Testing {{env2}} environment..."
    just state-quick {{env2}}
    @echo ""
    @echo "âœ… State comparison complete: {{env1}} vs {{env2}}"

# Convenience aliases for common environment combinations
compare-stage-dev02 testToRun=testToRun:
    just compare {{testToRun}} stage dev02

compare-dev-stage testToRun=testToRun:
    just compare {{testToRun}} dev stage

# List available environments
environments:
    @echo "Available environments:"
    @echo "  dev    - {{devUrl}}"
    @echo "  dev02  - {{dev02Url}}"
    @echo "  stage  - {{stageUrl}}"
    @echo "  prod   - {{prodUrl}}"
    @echo ""
    @echo "You can also pass custom URLs directly as the env parameter"

# Login performance tests with API request analysis
login-performance env="dev":
    @echo "ðŸš€ Testing login performance on {{env}}"
    just run login-performance {{env}}

login-propagation env="dev":
    @echo "ðŸ”„ Testing login state propagation on {{env}}"
    just run login-propagation {{env}}

# Compare login performance between environments
login-compare env1="stage" env2="dev":
    @echo "ðŸ”¬ Login Performance: {{env1}} vs {{env2}}"
    @echo "=================================="
    just login-performance {{env1}}
    just login-propagation {{env1}}
    @echo ""
    just login-performance {{env2}}
    just login-propagation {{env2}}
    @echo "âœ… Results include API request metrics in results/ directory"
