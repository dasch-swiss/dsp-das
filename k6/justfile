# Environment URLs
devUrl := "https://app.dev.dasch.swiss"
dev02Url := "https://app.dev-02.dasch.swiss"
stageUrl := "https://app.stage.dasch.swiss"
prodUrl := "https://app.dasch.swiss"

# Default settings
appUrl := devUrl
testToRun := "first-page-load"
#k6_browser_headless := "false"
k6_browser_headless := "true"

# List all the available targets
default:
    @just --list

# List all the available tests
list:
    @echo "Choose a test from below:"
    @echo ""
    @ls -1 tests|sed 's/\.js//'|awk '{print " * " $0}'
    @echo ""
    @echo "Run the test using 'just run <testName>'"

# Run test with flexible environment selection
run testToRun=testToRun env="dev" k6_browser_headless=k6_browser_headless:
    #!/usr/bin/env bash
    case "{{env}}" in
        "dev") url="{{devUrl}}" ;;
        "dev02") url="{{dev02Url}}" ;;
        "stage") url="{{stageUrl}}" ;;
        "prod") url="{{prodUrl}}" ;;
        *) url="{{env}}" ;;  # Allow custom URLs
    esac
    K6_BROWSER_HEADLESS={{k6_browser_headless}} APP_URL="$url" k6 run tests/{{testToRun}}.js

# Run all tests locally
run-all:
    APP_URL={{appUrl}} k6 run tests/first-page-load.js
    APP_URL={{appUrl}} k6 run tests/load-project-overview.js
    APP_URL={{appUrl}} k6 run tests/load-resource.js
    APP_URL={{appUrl}} k6 run tests/load-single-resource.js
    APP_URL={{appUrl}} k6 run tests/workflow-login-success.js

# Run the test in k6 cloud
run-cloud testToRun=testToRun:
    k6 cloud tests/{{testToRun}}.js

# Start grafana
grafana-up:
    docker compose up -d
    open http://localhost:3000/dashboard/new?orgId=1
    cat ./grafana_dashboard.json | pbcopy

# Stop grafana
grafana-down:
    docker compose down

# Run test with Grafana output (flexible environment)
run-grafana testToRun=testToRun env="dev":
    #!/usr/bin/env bash
    case "{{env}}" in
        "dev") url="{{devUrl}}" ;;
        "dev02") url="{{dev02Url}}" ;;
        "stage") url="{{stageUrl}}" ;;
        "prod") url="{{prodUrl}}" ;;
        *) url="{{env}}" ;;
    esac
    K6_OUT=influxdb=http://localhost:8086/k6 APP_URL="$url" k6 run ./tests/{{testToRun}}.js --tag env={{env}}

# Remove all screenshots
clean:
    rm screenshots/*.png


# Flexible comparison between any two environments
compare testToRun=testToRun env1="stage" env2="dev02":
    @echo "ðŸ”¬ Performance Comparison: {{testToRun}}"
    @echo "=================================="
    @echo "ðŸŸ¡ Testing {{env1}} environment..."
    just run {{testToRun}} {{env1}}
    @echo ""
    @echo "ðŸ”µ Testing {{env2}} environment..."
    just run {{testToRun}} {{env2}}
    @echo ""
    @echo "âœ… Comparison complete: {{env1}} vs {{env2}}"

# Store refactor regression tests (flexible environment)
regression-full env="dev":
    @echo "ðŸ”¬ Running comprehensive store refactor regression tests on {{env}}"
    just run store-refactor-regression {{env}}

regression-quick env="dev":
    @echo "ðŸ”¬ Running quick store refactor regression tests on {{env}}"
    just run store-refactor-regression-quick {{env}}

regression-micro env="dev":
    @echo "ðŸ”¬ Running micro-benchmark store performance tests on {{env}}"
    just run store-refactor-regression-micro {{env}}

regression-statistical env="dev":
    @echo "ðŸ“Š Running statistical regression tests with multiple iterations on {{env}}"
    just run store-refactor-regression-statistical {{env}}

# Compare regression tests between any two environments
regression-compare env1="stage" env2="dev02":
    @echo "ðŸ”¬ Store Regression Comparison: {{env1}} vs {{env2}}"
    @echo "======================================================="
    @echo "ðŸŸ¡ Testing {{env1}} environment..."
    just regression-quick {{env1}}
    @echo ""
    @echo "ðŸ”µ Testing {{env2}} environment..."
    just regression-quick {{env2}}
    @echo ""
    @echo "âœ… Regression comparison complete: {{env1}} vs {{env2}}"

# Convenience aliases for common environment combinations
compare-stage-dev02 testToRun=testToRun:
    just compare {{testToRun}} stage dev02

compare-dev-stage testToRun=testToRun:
    just compare {{testToRun}} dev stage

# List available environments
environments:
    @echo "Available environments:"
    @echo "  dev    - {{devUrl}}"
    @echo "  dev02  - {{dev02Url}}"
    @echo "  stage  - {{stageUrl}}"
    @echo "  prod   - {{prodUrl}}"
    @echo ""
    @echo "You can also pass custom URLs directly as the env parameter"
